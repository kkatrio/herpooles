<html>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    </head>
    <body>

        <button id="play-pause"></button>
        <canvas id="canvas"></canvas>
        <script type="module">
            import init, {draw, Herpooles, Zombie } from './pkg/fight_the_poo.js';

            // get canvas context
            const canvas = document.getElementById("canvas");
            canvas.width = 1000;
            canvas.height = 800;
            const ctx = canvas.getContext("2d");
            ctx.strokeRect(0, 0, canvas.width, canvas.height);


            async function run() {
                await init();

                // data
                let herpooles = new Herpooles();
                let zombie = new Zombie();

                // keyboard events
                let rightPressed = false;
                let leftPressed = false;
                let upPressed = false;
                let downPressed = false;
                const KeyboardHelper = { left: 37, up: 38, right: 39, down: 40 };
                document.addEventListener("keydown", () => {
                        if (event.keyCode === KeyboardHelper.right) {
                            rightPressed = true
                        }
                        if (event.keyCode === KeyboardHelper.left) {
                            leftPressed = true
                        }
                        if (event.keyCode === KeyboardHelper.up) {
                            upPressed = true
                        }
                        if (event.keyCode === KeyboardHelper.down) {
                            downPressed = true
                        }
                });
                document.addEventListener("keyup", () => {
                        if (event.keyCode === KeyboardHelper.right) {
                            rightPressed = false
                        }
                        if (event.keyCode === KeyboardHelper.left) {
                            leftPressed = false
                        }
                        if (event.keyCode === KeyboardHelper.up) {
                            upPressed = false
                        }
                        if (event.keyCode === KeyboardHelper.down) {
                            downPressed = false
                        }
                });

                // game play functions
                let animationId = null;
                const isPaused = () => {
                    return animationId === null;
                };
                const playPauseButton = document.getElementById("play-pause");
                playPauseButton.textContent = "⏸";

                const play = () => {
                    playPauseButton.textContent = "⏸";
                    animationId = window.requestAnimationFrame(step);
                };

                const pause = () => {
                    playPauseButton.textContent = "▶";
                    cancelAnimationFrame(animationId);
                    animationId = null;
                };

                playPauseButton.addEventListener("click", event => {
                    if (isPaused()) {
                      play();
                    } else {
                      pause();
                    }
                });


                // main loop
                function step() {
                    if (rightPressed) {
                        herpooles.x += 20;
                    } else if (leftPressed) {
                        herpooles.x -= 20;
                    }
                    if (upPressed) {
                        herpooles.y -= 20;
                    } else if (downPressed) {
                        herpooles.y += 20;
                    }
                    //console.log("step");
                    draw(ctx, herpooles, zombie);

                    if (herpooles.alive) {
                        animationId = window.requestAnimationFrame(step);
                    }
                    else
                    {
                        alert("GAME OVER");
                        document.location.reload();
                    }
                }

                //window.setInterval(step, 500);
                animationId = window.requestAnimationFrame(step);
            }

            run();
        </script>
    </body>
</html>
